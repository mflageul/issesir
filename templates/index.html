<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application ISESIR by Q&T - Analyse des enqu√™tes de satisfaction</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/feather-icons@4.29.0/dist/feather.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <div class="d-flex align-items-center">
                <img id="logo" src="{{ url_for('static', filename='images/logo.png') }}" 
                     alt="Logo RCBT" class="me-3 logo-navbar" style="display: none;">
                <div>
                    <span class="navbar-brand mb-0 h1">Application ISESIR by <img src="{{ url_for('static', filename='images/logo_qt.jpg') }}" alt="Q&T" style="height: 28px; vertical-align: middle; margin-left: 4px;"></span>
                    <small class="text-light d-block">Analyse des enqu√™tes de satisfaction v2.0</small>
                </div>
            </div>
            <div>
                <button class="btn btn-outline-light me-2" onclick="showHistory()">
                    <i data-feather="clock"></i> Historique
                </button>

                <button class="btn btn-outline-light" onclick="showUpdates()">
                    <i data-feather="star"></i> Mises √† jour
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Pending Inconsistencies Alert -->
        {% if has_pending_validation %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i data-feather="alert-triangle"></i>
            <strong>Incoh√©rences en attente !</strong> 
            Vous avez des incoh√©rences d√©tect√©es qui n√©cessitent une validation avant de pouvoir g√©n√©rer des rapports individuels fiables.
            <a href="/validate_inconsistencies" class="btn btn-sm btn-outline-dark ms-2">
                <i data-feather="check-square"></i>
                Valider maintenant
            </a>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <!-- File Upload Section -->
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i data-feather="folder"></i>
                    S√©lection des fichiers Excel
                </h5>
            </div>
            <div class="card-body">
                {% if files_loaded %}
                    <div class="alert alert-success" role="alert">
                        <i data-feather="check-circle"></i> Fichiers disponibles pour rapports individuels
                    </div>
                {% endif %}
                {% if session_restored %}
                    <div class="alert alert-info" role="alert">
                        <i data-feather="refresh-cw"></i> Session restaur√©e automatiquement
                    </div>
                {% endif %}
                <form id="uploadForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i data-feather="file-text"></i>
                                1. Fichier enqu√™tes (asmt_metric_result.xlsx)
                            </label>
                            <input type="file" class="form-control" id="enq_file" name="enq_file" 
                                   accept=".xlsx,.xls" required>
                            <div class="form-text">Donn√©es des enqu√™tes de satisfaction</div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i data-feather="layers"></i>
                                2. Fichier tickets (sn_customerservice_case.xlsx)
                            </label>
                            <input type="file" class="form-control" id="case_file" name="case_file" 
                                   accept=".xlsx,.xls" required>
                            <div class="form-text">Donn√©es des tickets de support</div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i data-feather="users"></i>
                                3. Fichier r√©f√©rence √©quipes (reference_equipes_sites.xlsx)
                            </label>
                            <input type="file" class="form-control" id="ref_file" name="ref_file" 
                                   accept=".xlsx,.xls" required>
                            <div class="form-text">R√©f√©rentiel des √©quipes et sites</div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i data-feather="user"></i>
                                4. Fichier comptes clients (customer_account.xlsx)
                            </label>
                            <input type="file" class="form-control" id="acct_file" name="acct_file" 
                                   accept=".xlsx,.xls" required>
                            <div class="form-text">Donn√©es des comptes clients</div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary btn-lg me-3">
                                <i data-feather="upload"></i>
                                T√©l√©charger les fichiers
                            </button>
                            <button type="button" id="generateBtn" class="btn btn-success btn-lg" disabled>
                                <i data-feather="file-plus"></i>
                                G√©n√©rer le rapport am√©lior√©
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="card shadow-sm mt-4" id="progressSection" style="display: none;">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i data-feather="activity"></i>
                    Progression
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <div id="progressText">Initialisation...</div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="card shadow-sm mt-4" id="resultsSection" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i data-feather="check-circle"></i>
                    R√©sultats de l'analyse
                </h5>
            </div>
            <div class="card-body">
                <div id="metricsPreview"></div>
                <div class="mt-3">
                    <button id="downloadBtn" class="btn btn-primary">
                        <i data-feather="download"></i>
                        T√©l√©charger le rapport HTML
                    </button>
                </div>
            </div>
        </div>

        <!-- Individual Reports Section -->
        <div class="card shadow-sm mt-4" id="individualReportsSection" style="display: none;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i data-feather="user"></i>
                    Rapports individuels
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Type de rapport</label>
                        <select class="form-select" id="reportType">
                            <option value="">S√©lectionner le type</option>
                            <option value="site">Par site</option>
                            <option value="collaborator">Par collaborateur</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">S√©lection</label>
                        <select class="form-select" id="reportTarget" disabled>
                            <option value="">Choisir d'abord le type</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button id="generateIndividualBtn" class="btn btn-success w-100" disabled>
                            <i data-feather="file-plus"></i>
                            G√©n√©rer
                        </button>
                    </div>
                </div>
                <div class="mt-3" id="individualProgress" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="mt-2"><span id="individualProgressText">G√©n√©ration en cours...</span></div>
                </div>
            </div>
        </div>



        <!-- Log Section -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i data-feather="terminal"></i>
                    Journal d'ex√©cution
                </h5>
            </div>
            <div class="card-body">
                <div id="logOutput" class="log-output"></div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i data-feather="clock"></i>
                        Historique des rapports
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="historyTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Filtre</th>
                                    <th>Fichier</th>
                                    <th>Total Tickets</th>
                                    <th>Nb r√©ponses Q1</th>
                                    <th>Taux Cl√¥ture</th>
                                    <th>Taux Satisfaction</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p class="mb-2">Application con√ßue et d√©velopp√©e par le p√¥le Q&T de la DESIR RCBT</p>
            <p class="mb-0 small">
                <a href="#" onclick="showContact()" style="color: #007bff; text-decoration: underline;">
                    En cas d'√©volutions ou anomalies, contactez-nous
                </a>
            </p>
        </div>
    </footer>

    <!-- Updates Modal -->
    <div class="modal fade" id="updatesModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i data-feather="star"></i>
                        Historique des mises √† jour
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-date">13/08/2025</div>
                            <div class="timeline-content">
                                <h6 class="fw-bold">üîß FINALISATION PROFESSIONNELLE - ISESIR</h6>
                                <ul class="mb-0">
                                    <li>‚úÖ Rebranding complet: "RCBT" ‚Üí "ISESIR by Pole QoS et Transformation SI Retail"</li>
                                    <li>‚úÖ Messages de d√©marrage professionnels avec hi√©rarchie organisationnelle compl√®te</li>
                                    <li>‚úÖ Correction erreur WERKZEUG_SERVER_FD - lancement sans erreur</li>
                                    <li>‚úÖ Correction erreur base de donn√©es "nb_reponses_q1" dans historique</li>
                                    <li>‚úÖ Interface utilisateur: "satisfaction boutiques" au lieu de "client"</li>
                                    <li>‚úÖ Contact technique: Flageul Martin - Direction Exploitation et SI Retail</li>
                                    <li>‚úÖ Scripts de lancement Windows (.bat) optimis√©s et professionnalis√©s</li>
                                    <li>üéØ Application ISESIR pr√™te pour d√©ploiement final</li>
                                </ul>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-date">11/08/2025</div>
                            <div class="timeline-content">
                                <h6 class="fw-bold">üöÄ VERSION FINALE - FIABILISATION COMPL√àTE</h6>
                                <ul class="mb-0">
                                    <li>‚úÖ Syst√®me fiabilisation tickets orphelins (358 tickets "Autres")</li>
                                    <li>‚úÖ Attribution automatique collaborateur ET site avec tra√ßabilit√©</li>
                                    <li>‚úÖ Page 4 corrig√©e: analyse TOUTES enqu√™tes Q1 (avec/sans commentaires)</li>
                                    <li>‚úÖ Suppression limitation ‚â•5 r√©ponses pour analyse compl√®te</li>
                                    <li>‚úÖ Interface nettoy√©e: bouton t√©l√©chargement supprim√©</li>
                                    <li>üéØ Application pr√™te pour d√©ploiement production</li>
                                </ul>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-date">08/08/2025</div>
                            <div class="timeline-content">
                                <h6 class="fw-bold">üÜï Rapports individuels + Correction taux retour</h6>
                                <ul class="mb-0">
                                    <li>‚úÖ Fonctionnalit√© rapports individuels par site/collaborateur</li>
                                    <li>‚úÖ Interface s√©lection dynamique avec donn√©es r√©elles</li>
                                    <li>üîß Correction critique: taux retour collaborateurs (100% ‚Üí r√©el)</li>
                                    <li>üîß Debug ajout√© pour surveillance calculs</li>
                                    <li>üìù Historique automatique des √©volutions majeures</li>
                                </ul>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-date">08/08/2025 - Matin</div>
                            <div class="timeline-content">
                                <h6 class="fw-bold">Finalisation interface et branding</h6>
                                <ul class="mb-0">
                                    <li>Int√©gration logo Q&T dans l'application et rapports</li>
                                    <li>Changement titre: "Application ISESIR by Q&T"</li>
                                    <li>Ajout footer avec contact d√©veloppeur</li>
                                    <li>Centralisation historique mises √† jour</li>
                                </ul>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-date">07/08/2025</div>
                            <div class="timeline-content">
                                <h6 class="fw-bold">Harmonisation calculs et colorisation</h6>
                                <ul class="mb-0">
                                    <li>Taux de retour coh√©rents (collaborateurs = boutiques)</li>
                                    <li>Page 2: % enqu√™tes avec commentaires par collaborateur</li>
                                    <li>Page 6: Liste boutiques jamais r√©pondu</li>
                                    <li>Page 7: Colorisation selon objectif ‚â•13%</li>
                                </ul>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-date">06/08/2025</div>
                            <div class="timeline-content">
                                <h6 class="fw-bold">Passage format HTML interactif</h6>
                                <ul class="mb-0">
                                    <li>Remplacement PDF par HTML responsive</li>
                                    <li>Rapports individuels par site/collaborateur</li>
                                    <li>Tableaux filtres et tri</li>
                                    <li>Navigation 7 pages avec onglets</li>
                                    <li>Graphiques en secteurs avec pourcentages</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div class="modal fade" id="contactModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i data-feather="mail"></i>
                        Contact d√©veloppeur
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-3">
                        <i data-feather="user" class="text-primary" style="width: 48px; height: 48px;"></i>
                    </div>
                    <h6 class="fw-bold">Flageul Martin</h6>
                    <p class="text-muted">D√©veloppeur - P√¥le Q&T DESIR RCBT</p>
                    <a href="mailto:mflageul@rcbt.fr" class="btn btn-primary">
                        <i data-feather="mail" class="me-2"></i>
                        mflageul@rcbt.fr
                    </a>
                    <div class="mt-3">
                        <small class="text-muted">
                            Pour toute √©volution, correction ou anomalie de l'application
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.29.0/dist/feather.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
